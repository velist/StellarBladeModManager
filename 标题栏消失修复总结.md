# 标题栏消失问题修复总结

## 问题描述
当窗口最大化时，标题栏完全消失，且在消失的区域能看到其他程序的窗口。

## 原因分析
1. 使用WindowStyle="None"和WindowChrome组合时，最大化计算有问题
2. 窗口最大化时，系统会移除透明窗口的非客户区（包括标题栏）
3. 最大化后窗口扩展范围不正确，导致标题栏被裁剪到屏幕外
4. DPI缩放兼容性问题，高DPI屏幕下未正确处理UseLayoutRounding和SnapsToDevicePixels

## 修复方案

### 1. 添加窗口消息处理
添加了WindowProc方法处理WM_GETMINMAXINFO消息，正确计算窗口最大化的位置和大小，确保标题栏不会超出可见区域。
```csharp
private void Window_SourceInitialized(object sender, EventArgs e)
{
    // 添加钩子处理窗口消息
    IntPtr handle = new WindowInteropHelper(this).Handle;
    HwndSource.FromHwnd(handle)?.AddHook(WindowProc);
}

private IntPtr WindowProc(IntPtr hwnd, int msg, IntPtr wParam, IntPtr lParam, ref bool handled)
{
    // 处理窗口最大化时的位置和大小
    if (msg == WM_GETMINMAXINFO)
    {
        // 获取当前屏幕信息（考虑多显示器）
        MINMAXINFO mmi = (MINMAXINFO)Marshal.PtrToStructure(lParam, typeof(MINMAXINFO));
        
        // 获取当前显示器工作区
        System.Windows.Forms.Screen screen = System.Windows.Forms.Screen.FromHandle(hwnd);
        System.Drawing.Rectangle workingArea = screen.WorkingArea;
        System.Drawing.Rectangle screenBounds = screen.Bounds;
        
        // 设置最大化时不覆盖任务栏
        mmi.ptMaxPosition.x = Math.Abs(workingArea.Left - screenBounds.Left);
        mmi.ptMaxPosition.y = Math.Abs(workingArea.Top - screenBounds.Top);
        mmi.ptMaxSize.x = workingArea.Width;
        mmi.ptMaxSize.y = workingArea.Height;
        
        Marshal.StructureToPtr(mmi, lParam, true);
        handled = true;
    }
    
    return IntPtr.Zero;
}
```

### 2. 改进DPI缩放处理
在App.xaml中的DarkFlatWindow样式中添加以下属性：
```xml
<Setter Property="UseLayoutRounding" Value="True"/>
<Setter Property="SnapsToDevicePixels" Value="True"/>
```

同时在Border元素中也添加了这些属性：
```xml
<Border BorderBrush="{TemplateBinding BorderBrush}" 
        BorderThickness="{TemplateBinding BorderThickness}"
        Background="{TemplateBinding Background}"
        UseLayoutRounding="True"
        SnapsToDevicePixels="True">
```

### 3. 添加必要的引用和结构定义
```csharp
using System.Runtime.InteropServices;
using System.Windows.Interop;

// 添加Win32 API结构和常量
[StructLayout(LayoutKind.Sequential)]
public struct POINT
{
    public int x;
    public int y;
}

[StructLayout(LayoutKind.Sequential)]
public struct MINMAXINFO
{
    public POINT ptReserved;
    public POINT ptMaxSize;
    public POINT ptMaxPosition;
    public POINT ptMinTrackSize;
    public POINT ptMaxTrackSize;
}

private const int WM_GETMINMAXINFO = 0x0024;
```

## 总结
这些修改能够解决窗口最大化时标题栏消失的问题。主要通过以下方式实现：

1. 正确处理WM_GETMINMAXINFO消息，确保窗口最大化时的位置和大小计算正确
2. 添加DPI缩放处理，解决高DPI显示器上的渲染问题
3. 确保窗口不会扩展到任务栏区域，保持标题栏可见

这是一个常见问题，主要是因为WPF的默认行为与WindowChrome结合使用时的不兼容性造成的。 