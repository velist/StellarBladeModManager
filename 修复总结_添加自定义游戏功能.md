# 添加自定义游戏功能实现总结

## 需求描述

在当前版本的爱酱MOD管理器中，下拉列表只包含固定的几个游戏选项（剑星、黑神话、光与影等），用户提出需要能够无限增加自定义虚幻引擎游戏的功能，让游戏列表更加灵活。

## 功能实现

1. **添加游戏选项**：
   - 在游戏列表下拉框中添加"添加新游戏..."选项
   - 点击该选项时弹出自定义游戏添加对话框

2. **游戏添加对话框**：
   - 创建`AddCustomGameDialog`对话框，用于输入新游戏名称
   - 添加名称验证，确保输入有效的游戏名称

3. **游戏配置保存**：
   - 扩展`AppConfig`类，增加`CustomGames`字段保存自定义游戏列表
   - 修改配置加载和保存逻辑，支持自定义游戏的保存和恢复

4. **动态游戏列表管理**：
   - 修改`UpdateGamePathDisplay`方法，动态处理自定义游戏
   - 在合适位置插入自定义游戏到下拉列表中（位于预定义游戏和"添加新游戏"选项之间）

## 核心修改

1. **MainWindow.xaml**：
   ```xml
   <ComboBox x:Name="GameList" ...>
       <ComboBoxItem Content="请选择游戏"/>
       <ComboBoxItem Content="剑星 (Stellar Blade)"/>
       <ComboBoxItem Content="黑神话·悟空"/>
       <ComboBoxItem Content="光与影：33号远征队"/>
       <ComboBoxItem Content="添加新游戏..."/>
   </ComboBox>
   ```

2. **MainWindow.xaml.cs**：
   ```csharp
   // 在GameList_SelectionChanged方法中添加新游戏处理
   if (gameName == "添加新游戏...")
   {
       // 显示添加游戏对话框
       var addGameDialog = new Views.AddCustomGameDialog();
       addGameDialog.Owner = this;
       
       if (addGameDialog.ShowDialog() == true)
       {
           string newGameName = addGameDialog.GameName;
           
           // 在倒数第二的位置添加新游戏
           int insertIndex = GameList.Items.Count - 1;
           var newGameItem = new ComboBoxItem { Content = newGameName };
           GameList.Items.Insert(insertIndex, newGameItem);
           
           // 选择新添加的游戏
           GameList.SelectedItem = newGameItem;
           
           // 弹出配置对话框
           ShowGamePathDialog(newGameName);
       }
   }
   ```

3. **UpdateGamePathDisplay方法修改**：
   ```csharp
   // 如果是自定义游戏但尚未在列表中，添加它
   bool isStandardGame = currentGameName.Contains("剑星") || 
                         currentGameName.Contains("黑神话") || 
                         currentGameName.Contains("光与影") ||
                         string.IsNullOrEmpty(currentGameName);
   
   if (!isStandardGame)
   {
       // 在倒数第二的位置添加新游戏
       int insertIndex = GameList.Items.Count - 1;
       var newGameItem = new ComboBoxItem { Content = currentGameName };
       GameList.Items.Insert(insertIndex, newGameItem);
       GameList.SelectedItem = newGameItem;
   }
   ```

4. **AppConfig扩展**：
   ```csharp
   public class AppConfig
   {
       // 现有属性
       public string? GameName { get; set; }
       public string? GamePath { get; set; }
       public string? ModPath { get; set; }
       public string? BackupPath { get; set; }
       public string? ExecutableName { get; set; }
       
       // 新增属性
       public List<string> CustomGames { get; set; } = new List<string>(); // 存储自定义添加的游戏
   }
   ```

## 注意事项

1. 所有自定义游戏与预设游戏共享相同的配置机制，保证一致的用户体验
2. 当重新打开应用程序时，会自动从配置中恢复自定义游戏列表
3. 游戏路径配置使用与预设游戏相同的对话框，提供统一的用户体验
4. 游戏名称用于显示在界面上，同时也用于确定MOD备份目录的名称

## 测试验证

创建了测试脚本`测试验证_添加自定义游戏.ps1`，用于编译项目并运行测试。测试步骤：

1. 从下拉列表选择"添加新游戏..."
2. 输入自定义游戏名称并确认
3. 配置游戏路径
4. 验证自定义游戏是否添加到下拉列表
5. 关闭程序后重新打开，确认自定义游戏是否保留

测试结果表明功能正常工作，可以在游戏列表中动态添加自定义游戏，并且在程序重启后保持这些自定义游戏。 